{% extends "./_base.html" %}
{% block title %}{{ mode }}{% endblock %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="container">
  <div class="row m-1 p-1">
    <div class="col-3">
      <a class="btn btn-block btn-primary" href="{% url 'tw_user' 'followers' %}">Followers</a>
    </div>
    <div class="col-3">
      <a class="btn btn-block btn-primary" href="{% url 'tw_user' 'friends' %}">Friends</a>
    </div>
    <div class="col-3">
      <a class="btn btn-block btn-primary" href="{% url 'tw_user' 'fol_not_in_fri' %}">Followers not in Friends</a>
    </div>
    <div class="col-3">
      <a class="btn btn-block btn-primary" href="{% url 'tw_user' 'fri_not_in_fol' %}">Friends not in Followers</a>
    </div>
  </div>
</div>

<div class="container" hidden>
  {% if is_paginated %}
  <ul class="pagination">
    {% if page_obj.has_previous %}
    <li><a href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>&nbsp;
    {% else %}
    <li class="disabled"><span>&laquo;</span></li>&nbsp;
    {% endif %}
    {% for i in paginator.page_range %}
    {% if page_obj.number == i %}
    &nbsp;<li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>&nbsp;
    {% else %}
    &nbsp;<li><a class="border" href="?page={{ i }}">&nbsp;{{ i }}&nbsp;</a></li>&nbsp;
    {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
    &nbsp;<li><a href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
    {% else %}
    &nbsp;<li class="disabled"><span>&raquo;</span></li>
    {% endif %}
  </ul>
  {% endif %}

  <table class="table table-striped">
    <thead class="thead-light">
      <tr>
	<td>#</td>
	<td>name(link)</td>
	<td>description</td>
	<td>tweets</td>
	<td>followers</td>
	<td>friends</td>
	<td>favourites</td>
	<td>p</td>
	<td>button</td>
	<td>neglect</td>
      </tr>
    </thead>
    <tbody>
      {% for user in object_list %}
      <tr>
	<td>{{ count_pre_page|add:forloop.counter }}</td>
	<td style="font-size:12px">
	  <a href="https://twitter.com/{{ user.screen_name }}"
	     target="_blank">
	    <img src="{{ user.profile_image_url }}"
		 height="36pt"/>
	    {{ user.name }}
	  </a>
	</td>
	<td style="font-size:12px">{{ user.description|truncatechars:50 }}</td>
	<td>{{ user.statuses_count }}</td>
	<td>{{ user.followers_count }}</td>
	<td>{{ user.friends_count }}</td>
	<td>{{ user.favourites_count }}</td>
	<td>
	  {% if user.protected is True %}
	  <img src={% static '/protected.png' %} />
	  {% else %}
	  {% endif %}
	</td>
	<td>
	  {% if mode == 'followers' or mode == 'fol_not_in_fri' %}
	  <a href="https://twitter.com/{{ user.screen_name }}?ref_src=twsrc%5Etfw"
	     class="twitter-follow-button"
	     data-show-count="false">
	    Follow
	  </a>
	  {% endif%}
	</td>
	<td><button style="font-size:12px" class="btn btn-danger btn-xs" id="neglect">neglect</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if is_paginated %}
  <ul class="pagination">
    {% if page_obj.has_previous %}
    <li><a href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>&nbsp;
    {% else %}
    <li class="disabled"><span>&laquo;</span></li>&nbsp;
    {% endif %}
    {% for i in paginator.page_range %}
    {% if page_obj.number == i %}
    &nbsp;<li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>&nbsp;
    {% else %}
    &nbsp;<li><a class="border" href="?page={{ i }}">&nbsp;{{ i }}&nbsp;</a></li>&nbsp;
    {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
    &nbsp;<li><a href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
    {% else %}
    &nbsp;<li class="disabled"><span>&raquo;</span></li>
    {% endif %}
  </ul>
  {% endif %}

</div>


<div class="container p-0">
  {% for user in object_list %}
  <div class="card mb-3" style="width: 100%;">
    <div class="row no-gutters">
      <div class="col-md-1 align-self-center text-center">
	{{ count_pre_page|add:forloop.counter }}
      </div>
      <div class="col-md-3 align-self-center">
	<div class="">
	  <a href="https://twitter.com/{{ user.screen_name }}" target="_blank">
	    <img class="card-img mx-auto d-block" src="{{ user.profile_image_url }}" style="height:64px; width:64px;"/>
	  </a>
	</div>
      </div>
      <div class="col-md-8">
	<div class="card-body">
          <h5 class="card-title">{{ user.name }}</h5>
	  {% if user.protected is True %}
	  <img src={% static '/protected.png' %} />
	  {% else %}
	  {% endif %}

          <p class="card-text">
	    <span class="badge badge-pill badge-primary">T</span>
	    {{ user.statuses_count|intcomma }}
	    <span class="badge badge-pill badge-primary"><</span>
	    {{ user.followers_count|intcomma }}
	    <span class="badge badge-pill badge-primary">></span>
	    {{ user.friends_count|intcomma }}
	    <span class="badge badge-pill badge-danger">L</span>
	    {{ user.favourites_count|intcomma }}
	  </p>
          <p class="card-text">
	    <small class="text-muted">
	      <div style="font-size:0.7rem">{{ user.description|truncatechars:200 }}</div>
	    </small>
	  </p>
	</div>
      </div>
    </div>
    <div class="card-footer text-muted">
      {% if user.following == False %}
      <div class="follow_{{ user.user_id }}">
	<button style="font-size:12px"
		class="btn btn-primary float-left follow"
		name="{{ user.user_id }}">
	  follow</button>
      </div>
      {% else %}
      <div class="unfollow_{{ user.user_id }}">
	<button style="font-size:12px"
		class="btn btn-outline-secondary float-left unfollow"
		name="{{ user.user_id }}">
	  unfollow</button>
      </div>
      {% endif %}
      <button style="font-size:12px" class="btn btn-danger float-right" id="neglect">neglect</button>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block script %}
<script>
 function getCookie(name) {
   var cookieValue = null;
   if (document.cookie && document.cookie !== '') {
     var cookies = document.cookie.split(';');
     for (var i = 0; i < cookies.length; i++) {
       var cookie = jQuery.trim(cookies[i]);
       // Does this cookie string begin with the name we want?
       if (cookie.substring(0, name.length + 1) === (name + '=')) {
         cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
         break;
       }
     }
   }
   return cookieValue;
 }
 var csrftoken = getCookie('csrftoken');
 function csrfSafeMethod(method) {
   // these HTTP methods do not require CSRF protection
   return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
 }
 $.ajaxSetup({
   beforeSend: function(xhr, settings) {
     if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
       xhr.setRequestHeader("X-CSRFToken", csrftoken);
     }
   }
 });

 $(document).on('click', '.follow', function(event) {
   let request = { user_id : $(this).prop('name'),};
   $.ajax({
     url: '{% url "tw_follow" %}',
     method: 'POST',
     contentType: "application/x-www-form-urlencoded; charset=UTF-8",
     data: request,
     async: true,
     timeout: 10000,
     datatype: 'json',
     success: function(data) {
       $( 'div.follow_'+data.user_id ).html('<button style="font-size:12px" class="btn btn-outline-secondary float-left unfollow" name="'+data.user_id+'">unfollow</button>');
       $( 'div.follow_'+data.user_id ).attr('class','unfollow_'+data.user_id);
     }
   })
 });

 $(document).on('click', '.unfollow', function(event) {
   let request = { user_id : $(this).prop('name'),};
   $.ajax({
     url: '{% url "tw_unfollow" %}',
     method: 'POST',
     contentType: "application/x-www-form-urlencoded; charset=UTF-8",
     data: request,
     async: true,
     timeout: 10000,
     datatype: 'json',
     success: function(data) {
       $( 'div.unfollow_'+data.user_id ).html('<button style="font-size:12px" class="btn btn-primary float-left follow" name="'+data.user_id+'">follow</button>');
       $( 'div.unfollow_'+data.user_id ).attr('class','follow_'+data.user_id);
     }
   })
 });
</script>
{% endblock %}
